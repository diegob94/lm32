#crt = files('crt.S')

testcases = [
  'test_add',
  'test_addi',
  'test_and',
  'test_andhi',
  'test_andi',
  'test_b',
  'test_be',
  'test_bg',
  'test_bge',
  'test_bgeu',
  'test_bgu',
  'test_bi',
  'test_bne',
  'test_break',
  'test_bret',
  'test_call',
  'test_calli',
  'test_cmpe',
  'test_cmpei',
  'test_cmpg',
  'test_cmpgi',
  'test_cmpge',
  'test_cmpgei',
  'test_cmpgeu',
  'test_cmpgeui',
  'test_cmpgu',
  'test_cmpgui',
  'test_cmpne',
  'test_cmpnei',
  'test_divu',
  'test_eret',
  'test_lb',
  'test_lbu',
  'test_lh',
  'test_lhu',
  'test_lw',
  'test_mmu',
  'test_modu',
  'test_mul',
  'test_muli',
  'test_nor',
  'test_nori',
  'test_or',
  'test_ori',
  'test_orhi',
  'test_ret',
  'test_sb',
  'test_scall',
  'test_sextb',
  'test_sexth',
  'test_sh',
  'test_sl',
  'test_sli',
  'test_sr',
  'test_sri',
  'test_sru',
  'test_srui',
  'test_sub',
  'test_sw',
  'test_xnor',
  'test_xnori',
  'test_xor',
  'test_xori',
]

link_script = files('linker.ld')

# NOTE: does not contain the autogenerated tests.

foreach tc : testcases
  source = tc + '.S'
  bin = executable(tc, source, 'crt.S',
    c_args : ['-Wa,-I' + meson.current_source_dir()],
    link_args : ['-T' + '@0@/@1@'.format(meson.source_root(), link_script[0])],
    link_depends : link_script,
    name_suffix : 'elf',
  )
  vh = custom_target(source + '_v',
    input : bin,
    output : tc + '.vh',
    command : [objcopy, '-O', 'verilog', '@INPUT@', '@OUTPUT@'],
    build_by_default : true,
  )
  test(tc, vvp,
    args : [tb_lm32_system, '+prog=' + vh.full_path()])
endforeach
